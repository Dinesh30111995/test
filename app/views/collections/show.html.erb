<% is_collection_owner = @collection.is_owner?(current_user) %>
<%= hidden_field_tag 'collection_id', @collection.address %>
<%= hidden_field_tag 'collection_ismultiple', @collection.multiple? %>
<%= hidden_field_tag 'is_collection_lazy_minted', @collection.is_lazy_minted? %>
<span id="eth_balance" class="curBnbBalance hide">0.0</span>
<span id="erc20_balance" class="curErc20Balance hide">0.0</span>
<span id="serviceFee" class="hide"><%= service_fee %></span>
<span id="contractType" class="hide"><%= @collection.nft_contract&.contract_type %></span>
<span id="contractAddress" class="hide"><%= @collection.nft_contract&.address %></span>
<%= render "comments/comment_mention" %>
<main class="main" >
  <div class="container">

    <div class="row">
      <!-- content -->
      <div class="col-12 col-md-6 col-xl-6">
        <div class="asset__item"  id="sticky-collection">

          <%#= cover_tag(@collection) %>
          <div class="card__cover sticky-custom">
            <% if ['audio/mp3', 'audio/webm', 'audio/mpeg'].include?(@collection.attachment.content_type)  %>
              <span class="collection-card-img audio_tag" style="background-image: url('<%= cover_url(@collection) %>')">
                <%= attachment_tag(@collection) %>
              </span>
            <% elsif ['application/pdf'].include?(@collection.attachment.content_type)  %>
              <span class="collection-card-img unaudio_tag" style="background-image: url('<%= cover_url(@collection) %>')">
                <object data="<%= url_for(@collection.attachment) %>" type="application/pdf" width="300" height="200">
                </object>
              </span>
            <%else%>
              <span class="collection-card-img unaudio_tag" style="background-image: url('<%= cover_url(@collection) %>')">
                <%= attachment_tag(@collection) %>
              </span>
            <%end%>
          </div>
        </div>
      </div>
      <!-- end content -->
      
      <!-- sidebar -->
      <div class="col-12 col-md-6 col-xl-6">
        <div class="asset__info">
          <div class="main__title main__title--page">
            <div class="creator_box">
              <div class="lft-flex">
                <div class="asset__author asset__author--verified">
                  <%= image_tag url_for(@collection.creator.profile_image) %>
                  <a href="<%=user_path(:id=>@collection.creator.address)%>">@<%= @collection.creator.full_name %></a>
                </div>
                <% owner = @collection.owner %>
                <% if !current_user %>
                  <a href="javascript:void(0);" class="follow_btn connect-to-wallet"><i class="fa fa-plus"></i> <%= t('users.show.follow') %></a>
                <% elsif current_user != owner %>
                  <%= link_to follow_unfollow_feed_index_path(id: owner.address), method: :post, remote: true, class: "follow_btn follow-html-#{owner.address}" do %>
                    <% if current_user.followees.include?(owner) %>
                      <i class="fa fa-minus"></i><%= t('users.show.unfollow') %>
                    <% else %>
                      <i class="fa fa-plus"></i>
                      <%= t('users.show.follow') %>
                    <% end %>
                  <% end %>
                <% end %>
                <span class="viewer_info follower-count-<%= owner.address %>"><%= number_to_kmb owner.followers.length %> Followers</span>
              </div>
              <div class="rit-flex">
                
                <div class="more_action_block">
                  <a class="more_action_btn ma_btn" href="javascript:void(0);" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <img src="/assets/nw_asset/share_icon.png" /> Share
                  </a>

                  <ul class="dropdown-menu header__profile-menu sharelist" aria-labelledby="dropdownMenuProfile">
                    <li>
                      <a class="social-media-share-btn" target=_blank href="https://www.facebook.com/sharer/sharer.php?u=<%= current_url %>&caption=<%= @collection.name %>&description=<%= markdown @collection.description %>" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
                      <i class="fa fa-facebook"></i> Facebook
                    </a></li>
                    <li><a class="social-media-share-btn" target=_blank href="https://twitter.com/share?url=<%= current_url %>&text=<%= @collection.name %>, <%= markdown @collection.description %>" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
                      <i class="fa fa-twitter"></i> Twitter
                    </a></li>
                    <li><a class="social-media-share-btn" target=_blank href="https://telegram.me/share/url?url=<%= current_url %>&text=<%= @collection.name %>, <%= markdown @collection.description %>" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
                      <i class="fa fa-telegram"></i> Telegram
                    </a></li>
                    <li><a class="social-media-share-btn" target=_blank href="mailto:subject=
                      <% @collection.name %>&body=<%= markdown @collection.description %> Link here:<%= current_url %>">
                      <i class="fa fa-envelope"></i> Email
                    </a></li>
                  </ul>
                </div>
                <% if current_user && @collection.is_owner?(current_user) %>

                  <div class="more_action_block">
                    <a class="more_action_btn ma_btn" href="javascript:void(0);" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      <img src="/assets/nw_asset/more_option.png" class="m-0" />
                    </a>

                    <ul class="dropdown-menu header__profile-menu" aria-labelledby="dropdownMenuProfile">
                      <% if current_user && current_user.is_approved? %>
                        <% if @collection.put_on_sale? %>
                          <li>
                            <a href="javascript:void(0)" onclick="window.show_modal('#removeSaleModal')"><%= t('collections.show.remove_from_sale') %></a>
                          </li>
                        <% else %>
                          <li>
                            <a href="javascript:void(0)" class="change-price" onclick="window.show_modal('#change-price')"><%= t('shared.put_on_sale') %></a>
                          </li>
                        <% end %>
                        <li>
                          <a href="javascript:void(0)" class="change-price" onclick="window.show_modal('#change-price')"><%= t('collections.show.change_price') %></a>
                        </li>
                        <%if !@collection.is_lazy_minted? %> 
                          <li>
                            <a href="javascript:void(0)" class="transfer-token" onclick="window.show_modal('#transferTokenForm')"><%= t('collections.show.transfer_token') %></a>
                          </li>
                          <li><%= link_to t('collections.show.burn_token'), 'javascript:void(0)', 'onclick': "window.show_modal('#burnModal')" %></li>
                        <%end%>
                        <% if @collection.delivery_on_purchase? && current_user != @collection.creator %>
                          <li>
                            <a href="javascript:void(0)" class="change-price" onclick="window.show_modal('#delivery-details')"><%= t('shared.delivery_details')%></a>
                          </li>
                        <% end %>
                      <% else %>
                        <% if @collection.put_on_sale? %>
                          <li><a href="" class="show-login-message"><%= t('collections.show.remove_from_sale') %></a></li>
                        <% else %>
                          <li>
                            <a href="javascript:void(0)" class="show-login-message change-price"><%= t('shared.put_on_sale') %></a>
                          </li>
                        <% end %>
                        <li>
                          <a href="javascript:void(0)" class="show-login-message change-price"><%= t('collections.show.change_price') %></a>
                        </li>
                        <%if !@collection.is_lazy_minted? %>
                          <li>
                            <a href="javascript:void(0)" class="show-login-message transfer-token"><%= t('collections.show.transfer_token') %></a>
                          </li>
                          <li>
                            <a href="javascript:void(0)" class="show-login-message"><%= t('collections.show.burn_token') %></a>
                          </li>
                        <% end %>
                      <% end %>
                    </ul>
                  </div>
                <% end %>
              </div>
            </div>

            <h1><%= @collection.title %></h1>
            <% if @collection.state != 'feed' %>
            <div class="price_block">
              <div class="lft-flex">
                <% if @collection.instant_sale_price.present? and !@collection.is_in_reserve_drop? %>
                <h4>
                  <span class="crypto_price"><%=@collection.instant_sale_price%> <%= @collection.erc20_token.symbol %></span>
                  <span class="dollar_price">$<%= @collection.sale_price_to_fiat @collection.instant_sale_price, @collection.erc20_token.symbol %> of 1</span>
                </h4>
                <%elsif !@collection.put_on_sale?%>
                  <p><%= t('common.not_for_sale')%></p>
                <% end %>
              </div>
              <div class="rit-flex">
                <ul>
                  <li>
                    <a href="<%= pinata_url @collection %>" target="_blank">
                      View on IPFS <img src="/assets/nw_asset/external.png" />
                    </a>
                  </li>
                  <li>
                    <a href="<%= explorer_transaction @collection %>" target="_blank">
                      View on <%= Current.network.scan %>
                      <img src="/assets/nw_asset/external.png" />
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            <% end %>
          </div>
          <div class="asset__desc">
            <!--<p><%= @collection.title_desc %></p>-->
            <p><%= markdown @collection.description%></p>
            <% if @collection.owner == current_user && @collection.unlock_on_purchase && @collection.unlock_description.present? %>
              <p><%= @collection.unlock_description %></p>
            <% end %>
          </div>

          <% if @collection.put_on_sale? && @collection.state != 'feed' %>
            <% if @max_bid %>
              <div class="asset__wrap">
                <div class="asset__timer asset__price">
                  <!--<div class="asset__clock">555 days 06:02:08</div>-->
                  <span><%= t('collections.show.highest_bid') %></span>
                  <span><%= @max_bid.value %></span>
                </div>

                <div class="asset__price">
                  <span><%= t('collections.show.lowest_bid') %></span>
                  <span><%= @collection.min_bid.value %></span>
                </div>
              </div>
            <% end %>

            <% if @collection.auction_running? %>
              <ul class="asset__authors custom-styles collection-default-ul">
                <li class="second-child border-left-sec-child">
                  <%= hidden_field_tag 'collection[end_time]', @collection.auction_timing, class:'timed-action-trigger', data: { 'collection-show': true } %>
                  <div style="display:none" class="end-action"><%=t('collections.show.action_ended') %></div>
                  <div id="timedAuction-countdown">
                    <%= @collection.start_time.future? ? t('collections.show.action_starts') : t('collections.show.action_ends') %>
                    <ul class="my-collection">
                      <li><span id="tA-days"></span>Days</li>
                      <li><span id="tA-hours"></span>Hours</li>
                      <li><span id="tA-minutes"></span>Minutes</li>
                      <li><span id="tA-seconds"></span>Seconds</li>
                    </ul>
                  </div>
                </li>
              </ul>
            <% elsif @collection.auction_ended? %>
              <ul class="asset__authors custom-styles collection-default-ul">
                <li class="second-child border-left-sec-child">
                  <div id="timedAuction-countdown">
                    <%=t('collections.show.action_ended') %>
                  </div>
                </li>
              </ul>
            <% end %>

            <!-- actions -->
            <% if !is_collection_owner && @collection.published? %>
              <div class="row full-width" id="collection-actions">
                <div class="col-sm-12">
                  <% if @collection.allowed_for_instant_buy? && !@collection.is_in_reserve_drop? %>
                    <div class="asset__btns text-center">
                      <% if current_user && current_user.is_approved? %>
                        <a href="javascript:void(0)" onclick="window.show_modal('#Buy-modal')" class="home__btn home__btn--clr buy-now"><%= t('shared.buy_now') %></a>
                      <% else %>
                        <a href="" class="home__btn home__btn--clr show-login-message"><%= t('shared.buy_now') %></a>
                      <% end %>
                    </div>
                  <% end %>
                  <%if @collection.allowed_for_bid? %>
                    <div class="asset__btns text-center">
                      <% if current_user && current_user.is_approved? %>
                        <a href="javascript:void(0)" onClick="window.show_modal('#Bid-modal')" class="home__btn home__btn--clr bid-now"><%= t('collections.show.place_a_bid') %></a>
                      <% else %>
                        <a href="" class="home__btn home__btn--clr show-login-message"><%= t('collections.show.place_a_bid') %></a>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>

              <% if @collection.is_eligible_for_swap? %>
                <div class="row full-width">
                  <div class="col-12 col-sm-12">
                    <div class="asset__btns text-center">
                      <% if current_user && current_user.is_approved? %>
                        <a href="javascript:void(0)" onClick="show_modal('#swap-modal')" class="home__btn home__btn--clr"><%= t('collections.show.swap_btn') %></a>
                      <% else %>
                        <a href="" class="home__btn home__btn--clr show-login-message"><%= t('collections.show.swap_btn') %></a>
                      <% end %>
                    </div>
                  </div>
                </div>  
              <% end %>
            <% end %>
            <!-- end actions -->
          <% end %>
        </div>
      </div>
      <!-- end sidebar -->
    </div>

    <!-- explore -->
    <section class="row row--grid">
      <div class="col-sm-12">
        <!-- tabs -->
          <ul class="nav nav-tabs asset__tabs" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" data-toggle="tab" href="#tab-1" role="tab" aria-controls="tab-1" aria-selected="true"><%= t('collections.show.history') %></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-toggle="tab" href="#tab-2" role="tab" aria-controls="tab-2" aria-selected="false"><%= t('collections.show.bids') %></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-toggle="tab" href="#tab-3" role="tab" aria-controls="tab-3" aria-selected="false"><%= t('collections.show.details') %></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-toggle="tab" href="#tab-4" role="tab" aria-controls="tab-3" aria-selected="false"><%= t('collections.show.owners') %></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-toggle="tab" href="#tab-5" role="tab" aria-controls="tab-5" aria-selected="false"><%= t('collections.show.swaps') %></a>
            </li>
          </ul>
        <!--tabs Header-->
      </div>
      <!-- title -->
      <div class="col-12 col-lg-7 border-right">
          <!--tabs Content-->
          <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-1" role="tabpanel">
              <div class="asset__actions S" id="asset__actions--scroll" data-scrollbar="true" tabindex="-1" style="overflow: hidden; outline: none;">
                <div class="scroll-content">
                  <% if @activities.present? %>
                    <% @activities.each do |activity| %>
                      <%= render "activities/collection_card_activity", activity: activity %>
                    <% end %>
                  <% else %>
                    <%= render partial: 'common/empty' %>
                  <% end %>

                </div>
                <!-- <div class="scrollbar-track scrollbar-track-x show" style="display: none;"><div class="scrollbar-thumb scrollbar-thumb-x" style="width: 524px; transform: translate3d(0px, 0px, 0px);"></div></div><div class="scrollbar-track scrollbar-track-y show" style="display: block;"><div class="scrollbar-thumb scrollbar-thumb-y" style="height: 101.407px; transform: translate3d(0px, 0px, 0px);"></div></div>-->
              </div>
            </div>

            <div class="tab-pane fade" id="tab-2" role="tabpanel">

              <div class="asset__actions">
                <% @collection.bids.by_desc.pending.each do |bid| %>
                <%= render partial: 'bid', locals: {is_collection_owner: is_collection_owner, bid: bid} %>
                <% end %>
              </div>
            </div>

            <div class="tab-pane fade" id="tab-3" role="tabpanel">

              <ul class="asset__authors asset__authors--tab">
                <li>
                  <span><%= t('collections.show.owner') %></span>
                  <div class="asset__author asset__author--verified">
                    <%= image_tag url_for(@collection.owner.profile_image) %>
                    @<%= link_to @collection.owner.full_name, user_path(@collection.owner.address) %>
                  </div>
                </li>
                <li>
                  <span><%= t('collections.show.year_created') %></span>
                  <p><%= @collection.created_at.strftime("%Y") %></p>
                </li>
                <% if (current_user && @collection.can_view_delivery_details?(current_user.id)) or (@collection.owner == current_user && @collection.delivery_on_purchase && (@collection.delivery_details.present? || @collection.delivery_email.present?)) %>
                  <li>
                    <span>Delivery Details:</span>
                  </li>
                  <li>
                    <span>Email:</span>
                    <p><%=@collection.delivery_email %></p>
                  </li>
                  <li>
                    <span>Address:</span>
                    <p><%=@collection.delivery_details%></p>
                  </li>
                <% end %>
                <li>
                  <% if @collection.data.present? %>
                    <span>Properties</span>
                    <%@collection.data.each do |key,value|%>
                      <div class='proprties-collection'>
                        <span class="properties-key"><%= key %></span>
                        <span class="properties-value"><%= value %></span>
                      </div>
                    <%end%>
                  <%end%>
                </li>
              </ul>
            </div>

            <div class="tab-pane fade" id="tab-4" role="tabpanel">
              <div class="asset__actions S" id="asset__actions--scroll" data-scrollbar="true" tabindex="-1" style="overflow: hidden; outline: none;">
                <div class="scroll-content">
                  <% @collection.get_collections.each do |collection| %>
                    <%= render partial: 'collections/owner', locals: {collection: collection} %>
                  <% end %>
                </div>
              </div>
            </div>

            <div class="tab-pane fade" id="tab-5" role="tabpanel">

              <div class="asset__actions">
                <% @collection.owner_swaps.pending.by_desc.each do |swap| %>
                <%= render partial: 'swap', locals: {is_collection_owner: is_collection_owner, swap: swap} %>
                <% end %>
              </div>
            </div>
          </div>
        <!-- end tabs -->
      </div>
      <!-- end title -->
      <div class="col-12 col-lg-5">
        <%= render "comments/comment_section", collection: @collection %>
      </div>
     
    </section>
    <!-- end explore -->
  </div>
</main>
<%= render partial: 'collections/price_change' %>

<%= render partial: 'collections/token_transfer' %>

<%= render partial: 'collections/bid_modal' %>
<% if current_user %>
  <%= render partial: 'collections/swap_modal'%>
  <%= render partial: 'collections/approve_swap_modal'%>
<% end %>
<%= render partial: 'collections/burn_modal' %>

<%= render partial: 'collections/remove_sale_modal' %>
<%= render partial: 'collections/delivery_details' %>

<% if is_collection_owner %>
  <%= render partial: 'collections/execute_bid' %>
  <div id="approveSwap" class="zoom-anim-dialog mfp-hide modal sm_modal">
    <button class="modal__close md_cls" type="button"><i class="fas fa-times"></i></button>
    <h4 class="modal-title share_link_page_h4"><%= t('shared.follow_steps')%></h4>
          <div class="signMsg">
            <%= render partial: 'accept_swap' %>
          </div>
        </div>
  </div>
<% end %>

<%= render partial: 'collections/buy_modal' %>
<div class="zoom-anim-dialog mfp-hide modal sm_modal" id="approveSwapRequest">
  <button class="modal__close md_cls" type="button"><i class="fas fa-times"></i></button>
  <h4 class="modal-title share_link_page_h4"> <%= t('shared.follow_steps') %></h4>
  <div class="signMsg">
    <%= render partial: 'approve_swap' %>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function () {
    $("#bid_amt, #bid_currency, #bid_qty").on('input', function () {
      calculateBid($('#serviceFee').text());
    });
    $("#buy_qty").on('input', function () {
      calculateBuy($('#serviceFee').text());
    });


    $(document).on("change", "#collection-put-on-sale", function () {
      if (!$(this).is(":checked")) {
        $('#collection_instant_sale_enabled').prop("checked", false).change();
        $('#collection-unlock-on-purchase').prop("checked", false).change();
      }
    })

    <% if params[:act] %>
      setTimeout(function(){
        window.show_modal('#<%=params[:act]%>')
      }, 600);
    <% end %>
      function show_modal(id) {
          $.magnificPopup.open({
              closeOnBgClick: false ,
              enableEscapeKey: false,
              items: {
                  src: id
              },
              type: 'inline'
          });
      }

    $(document).on("change", "#collection_instant_sale_select", function () {
      if ($(this).is(":checked")) {
        $("#instant-price").closest(".row").removeClass("hide")
      } else {
        $("#instant-price").closest(".row").addClass("hide")
      }
    });

    $(document).on("change", "#collection-unlock-on-purchase", function () {
      if ($(this).is(":checked")) {
        $(".unlock-description-section").removeClass("hide")
      } else {
        $(".unlock-description-section").addClass("hide")
      }
    });

  });
</script>